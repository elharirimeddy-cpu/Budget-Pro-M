<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BUDGET</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #f2f2f7;
            color: #000;
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 22px; font-weight: 600; }
        h3 { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #8e8e93; }
        
        .status { 
            position: fixed; 
            top: 0; 
            left: 50%; 
            transform: translateX(-50%);
            width: 100%; 
            max-width: 430px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px; 
            font-size: 12px; 
            font-weight: 600;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        .container { padding: 70px 16px 100px; }
        
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .card-dark {
            background: #000000;
            color: #fff;
        }
        
        .amount {
            font-size: 40px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-top: 8px;
        }
        
        .amount-small {
            font-size: 28px;
            font-weight: 600;
        }
        
        input, select {
            width: 100%;
            padding: 14px 0;
            border: none;
            border-bottom: 1px solid #e5e5ea;
            background: transparent;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }
        
        input:focus { border-bottom-color: #007aff; }
        
        button {
            width: 100%;
            padding: 14px;
            background: #007aff;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        button:active { opacity: 0.8; }
        
        .btn-outline {
            background: transparent;
            color: #007aff;
            border: 1px solid #007aff;
        }
        
        .btn-ghost {
            background: #f2f2f7;
            color: #000;
        }
        
        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-danger {
            background: #ff3b30;
            color: #fff;
            border: none;
        }
        
        .nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #e5e5ea;
            display: flex;
            justify-content: space-around;
            padding: 8px 0 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            opacity: 0.4;
        }
        
        .nav-item.active { opacity: 1; }
        
        .nav-item .icon { font-size: 22px; display: block; margin-bottom: 4px; }
        .nav-item .label { font-size: 10px; font-weight: 500; }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f2f2f7;
        }
        
        .list-item:last-child { border-bottom: none; }
        
        .progress-bar {
            height: 6px;
            background: #e5e5ea;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: #34c759;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .setup-screen {
            min-height: 100vh;
            display: none;
            flex-direction: column;
            justify-content: center;
            padding: 40px 24px;
            background: #f2f2f7;
        }
        
        .setup-screen.active {
            display: flex;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 24px 0;
        }
        
        .avatar-option {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            background: #fff;
            border-radius: 16px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .avatar-option.selected {
            border-color: #007aff;
            background: #e1f0ff;
        }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .positive { color: #34c759; }
        .negative { color: #ff3b30; }
        
        canvas { display: block; width: 100%; margin-top: 16px; }
        
        .edit-form {
            display: none;
            background: #f2f2f7;
            padding: 12px;
            border-radius: 12px;
            margin-top: 8px;
        }
        
        .edit-form.active {
            display: block;
        }
    </style>
</head>
<body>

    <div class="status">BUDGET</div>

    <!-- SETUP -->
    <div id="setup0" class="setup-screen active">
        <h1>Benvenuto</h1>
        <p style="color: #8e8e93; margin: 8px 0 24px;">Scegli il tuo avatar</p>
        <div class="avatar-grid">
            <div class="avatar-option selected" onclick="selectAvatar(this, 'üë§')">üë§</div>
            <div class="avatar-option" onclick="selectAvatar(this, 'üë©')">üë©</div>
            <div class="avatar-option" onclick="selectAvatar(this, 'üë®')">üë®</div>
            <div class="avatar-option" onclick="selectAvatar(this, 'üßë')">üßë</div>
            <div class="avatar-option" onclick="selectAvatar(this, 'üë±')">üë±</div>
            <div class="avatar-option" onclick="selectAvatar(this, 'üßî')">üßî</div>
        </div>
        <input type="text" id="inputNome" placeholder="Il tuo nome">
        <button onclick="goSetup1()">Continua</button>
    </div>

    <div id="setup1" class="setup-screen">
        <h1>Le tue entrate</h1>
        <p style="color: #8e8e93; margin: 8px 0 24px;">Quanto guadagni al mese?</p>
        <input type="number" id="inputEntrate" placeholder="0" style="font-size: 40px; text-align: center;">
        <button onclick="goSetup2()">Continua</button>
    </div>

    <div id="setup2" class="setup-screen">
        <h1>Spese fisse</h1>
        <p style="color: #8e8e93; margin: 8px 0 16px;">Affitto, bollette, abbonamenti...</p>
        <div id="listaFisseSetup"></div>
        <input type="text" id="inputFissaNome" placeholder="Nome (es. Affitto)">
        <input type="number" id="inputFissaPrezzo" placeholder="Importo ‚Ç¨">
        <button onclick="addFissaSetup()" class="btn-outline" style="margin-bottom: 12px;">Aggiungi</button>
        <p style="text-align: center; color: #8e8e93; font-size: 14px; margin: 16px 0;">
            Totale: <span id="totFisse" style="color: #000; font-weight: 600;">‚Ç¨0</span>
        </p>
        <button onclick="finishSetup()">Inizia</button>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display:none;">
        <div class="container">
            
            <div style="margin-bottom: 20px;">
                <h3>Budget Mensile</h3>
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 4px;">
                    <h1 id="displayNome">Nome</h1>
                    <span id="displayData" style="font-size: 13px; color: #8e8e93;"></span>
                </div>
            </div>

            <div class="card card-dark">
                <h3 style="color: #8e8e93;">Disponibile</h3>
                <div class="amount" id="displayLibero" style="color: #34c759;">‚Ç¨0</div>
                <div style="display: flex; gap: 24px; margin-top: 20px;">
                    <div>
                        <p style="font-size: 11px; color: #8e8e93; text-transform: uppercase;">Entrate</p>
                        <p id="displayEntrate" style="font-size: 17px; font-weight: 600; color: #fff; margin-top: 4px;">‚Ç¨0</p>
                    </div>
                    <div>
                        <p style="font-size: 11px; color: #8e8e93; text-transform: uppercase;">Spese</p>
                        <p id="displaySpese" style="font-size: 17px; font-weight: 600; color: #ff453a; margin-top: 4px;">‚Ç¨0</p>
                    </div>
                </div>
            </div>

            <!-- HOME -->
            <div id="section-home" class="section active">
                <div class="card">
                    <h3>Nuova Spesa</h3>
                    <input type="text" id="inputSpesaNome" placeholder="Cosa hai comprato?">
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="inputSpesaPrezzo" placeholder="‚Ç¨" style="flex: 1;">
                        <select id="inputSpesaTipo" style="flex: 1;">
                            <option value="Cibo">üçΩÔ∏è Cibo</option>
                            <option value="Casa">üè† Casa</option>
                            <option value="Trasporti">üöó Trasporti</option>
                            <option value="Svago">üéÆ Svago</option>
                            <option value="Altro">üì¶ Altro</option>
                        </select>
                    </div>
                    <input type="date" id="inputSpesaData">
                    <button onclick="addSpesa()">Aggiungi</button>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3>Recenti</h3>
                        <button class="btn-small btn-ghost" onclick="clearFilter()">Tutti</button>
                    </div>
                    <div id="listaSpese"></div>
                </div>
            </div>

            <!-- GOALS -->
            <div id="section-goals" class="section">
                <div class="card">
                    <h3>Nuovo Obiettivo</h3>
                    <input type="text" id="inputGoalNome" placeholder="Per cosa risparmi?">
                    <input type="number" id="inputGoalTarget" placeholder="Importo obiettivo ‚Ç¨">
                    <button onclick="createGoal()" class="btn-outline">Crea</button>
                </div>
                <div id="listaGoals"></div>
            </div>

            <!-- STATS -->
            <div id="section-stats" class="section">
                <div class="card">
                    <h3>Andamento</h3>
                    <canvas id="chartTrend" height="180"></canvas>
                </div>
                <div class="card">
                    <h3>Categorie</h3>
                    <canvas id="chartPie" height="180"></canvas>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="section-settings" class="section">
                <div class="card">
                    <h3>Profilo</h3>
                    <div class="list-item">
                        <div>
                            <h4 id="settingsNome" style="font-size: 17px; font-weight: 600;">Nome</h4>
                            <p style="font-size: 13px; color: #8e8e93;">Membro dal <span id="settingsData"></span></p>
                        </div>
                        <button class="btn-small btn-ghost" onclick="editName()">Modifica</button>
                    </div>
                </div>

                <!-- NUOVA SEZIONE: SPESE FISSE -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3>Spese Fisse Mensili</h3>
                        <button class="btn-small btn-outline" onclick="toggleFixedForm()">+ Aggiungi</button>
                    </div>
                    
                    <!-- Form per aggiungere nuova spesa fissa -->
                    <div id="fixedForm" class="edit-form">
                        <input type="text" id="newFixedName" placeholder="Nome (es. Affitto)" style="margin-bottom: 8px;">
                        <input type="number" id="newFixedAmount" placeholder="Importo mensile ‚Ç¨" style="margin-bottom: 8px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="addFixedExpense()" style="flex: 1;">Salva</button>
                            <button onclick="toggleFixedForm()" class="btn-ghost" style="flex: 1;">Annulla</button>
                        </div>
                    </div>
                    
                    <!-- Lista spese fisse -->
                    <div id="fixedExpensesList"></div>
                    
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f2f2f7;">
                        <div style="display: flex; justify-content: space-between; font-size: 15px; font-weight: 600;">
                            <span>Totale fisse:</span>
                            <span id="totalFixedDisplay">‚Ç¨0</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Backup</h3>
                    <button onclick="copyBackup()" class="btn-outline" style="margin-bottom: 8px;">Copia dati</button>
                    <div id="backupDisplay" style="font-family: monospace; font-size: 10px; color: #8e8e93; word-break: break-all; display: none; margin-bottom: 12px; padding: 10px; background: #f2f2f7; border-radius: 8px;"></div>
                    <input type="text" id="inputRestore" placeholder="Incolla codice backup..." style="font-size: 14px;">
                    <button onclick="restoreBackup()" style="margin-top: 8px;">Ripristina</button>
                </div>

                <button onclick="deleteAll()" class="btn-danger">Elimina tutti i dati</button>
            </div>

        </div>

        <!-- NAV -->
        <div class="nav">
            <div class="nav-item active" onclick="switchTab('home', this)">
                <span class="icon">üí∞</span>
                <span class="label">Budget</span>
            </div>
            <div class="nav-item" onclick="switchTab('goals', this)">
                <span class="icon">üéØ</span>
                <span class="label">Obiettivi</span>
            </div>
            <div class="nav-item" onclick="switchTab('stats', this)">
                <span class="icon">üìä</span>
                <span class="label">Stats</span>
            </div>
            <div class="nav-item" onclick="switchTab('settings', this)">
                <span class="icon">‚öôÔ∏è</span>
                <span class="label">Impostazioni</span>
            </div>
        </div>
    </div>

<script>
let data = {
    user: { name: '', avatar: 'üë§', created: new Date().toISOString() },
    income: 0,
    fixed: [],
    expenses: [],
    goals: [],
    setup: false
};

let currentFilter = 'all';
let editingFixedId = null;

document.addEventListener('DOMContentLoaded', () => {
    loadData();
    const dateInput = document.getElementById('inputSpesaData');
    if(dateInput) dateInput.valueAsDate = new Date();
    
    // Se l'utente ha gi√† completato il setup, mostra direttamente l'app
    if(data.setup && data.user.name && data.income > 0) {
        hideAllSetup();
        showApp();
    }
});

function hideAllSetup() {
    document.getElementById('setup0').classList.remove('active');
    document.getElementById('setup0').style.display = 'none';
    document.getElementById('setup1').classList.remove('active');
    document.getElementById('setup1').style.display = 'none';
    document.getElementById('setup2').classList.remove('active');
    document.getElementById('setup2').style.display = 'none';
}

function selectAvatar(el, avatar) {
    document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
    el.classList.add('selected');
    data.user.avatar = avatar;
}

function goSetup1() {
    const name = document.getElementById('inputNome').value.trim();
    if(!name) return alert('Inserisci il tuo nome');
    data.user.name = name;
    document.getElementById('setup0').classList.remove('active');
    document.getElementById('setup0').style.display = 'none';
    document.getElementById('setup1').classList.add('active');
}

function goSetup2() {
    const income = parseFloat(document.getElementById('inputEntrate').value);
    if(!income || income <= 0) return alert('Inserisci le tue entrate');
    data.income = income;
    document.getElementById('setup1').classList.remove('active');
    document.getElementById('setup1').style.display = 'none';
    document.getElementById('setup2').classList.add('active');
    document.getElementById('displayNome').textContent = data.user.name;
}

function addFissaSetup() {
    const name = document.getElementById('inputFissaNome').value.trim();
    const amount = parseFloat(document.getElementById('inputFissaPrezzo').value);
    if(!name || !amount) return;
    data.fixed.push({ id: Date.now(), name, amount });
    document.getElementById('inputFissaNome').value = '';
    document.getElementById('inputFissaPrezzo').value = '';
    updateFisseSetup();
}

function updateFisseSetup() {
    const total = data.fixed.reduce((a, f) => a + f.amount, 0);
    document.getElementById('totFisse').textContent = '‚Ç¨' + total.toFixed(0);
    const list = document.getElementById('listaFisseSetup');
    list.innerHTML = data.fixed.map(f => `
        <div class="list-item">
            <span style="font-size: 15px;">${f.name}</span>
            <span style="font-size: 15px; font-weight: 600;">‚Ç¨${f.amount}</span>
        </div>
    `).join('');
}

function finishSetup() {
    data.setup = true;
    saveData();
    hideAllSetup();
    showApp();
}

function showApp() {
    document.getElementById('mainApp').style.display = 'block';
    updateHeader();
    updateBudget();
    updateExpenses();
    updateGoals();
    updateFixedExpensesList(); // Aggiorna la lista nelle impostazioni
}

// NUOVE FUNZIONI PER GESTIONE SPESE FISSE
function toggleFixedForm() {
    const form = document.getElementById('fixedForm');
    form.classList.toggle('active');
    if(!form.classList.contains('active')) {
        // Reset form
        document.getElementById('newFixedName').value = '';
        document.getElementById('newFixedAmount').value = '';
        editingFixedId = null;
    }
}

function addFixedExpense() {
    const name = document.getElementById('newFixedName').value.trim();
    const amount = parseFloat(document.getElementById('newFixedAmount').value);
    
    if(!name || !amount) return alert('Inserisci nome e importo');
    
    if(editingFixedId) {
        // Modifica esistente
        const index = data.fixed.findIndex(f => f.id === editingFixedId);
        if(index !== -1) {
            data.fixed[index].name = name;
            data.fixed[index].amount = amount;
        }
        editingFixedId = null;
    } else {
        // Nuova spesa
        data.fixed.push({ id: Date.now(), name, amount });
    }
    
    saveData();
    updateFixedExpensesList();
    updateBudget();
    toggleFixedForm();
}

function editFixedExpense(id) {
    const fixed = data.fixed.find(f => f.id === id);
    if(!fixed) return;
    
    document.getElementById('newFixedName').value = fixed.name;
    document.getElementById('newFixedAmount').value = fixed.amount;
    editingFixedId = id;
    
    document.getElementById('fixedForm').classList.add('active');
}

function deleteFixedExpense(id) {
    if(!confirm('Eliminare questa spesa fissa?')) return;
    data.fixed = data.fixed.filter(f => f.id !== id);
    saveData();
    updateFixedExpensesList();
    updateBudget();
}

function updateFixedExpensesList() {
    const container = document.getElementById('fixedExpensesList');
    const totalDisplay = document.getElementById('totalFixedDisplay');
    
    if(!container) return;
    
    const total = data.fixed.reduce((a, f) => a + f.amount, 0);
    totalDisplay.textContent = '‚Ç¨' + total.toFixed(0);
    
    if(data.fixed.length === 0) {
        container.innerHTML = '<p style="color: #8e8e93; text-align: center; padding: 20px;">Nessuna spesa fissa</p>';
        return;
    }
    
    container.innerHTML = data.fixed.map(f => `
        <div class="list-item" style="align-items: flex-start;">
            <div style="flex: 1;">
                <div style="font-size: 15px; font-weight: 500;">${f.name}</div>
                <div style="font-size: 13px; color: #8e8e93;">‚Ç¨${f.amount}/mese</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="editFixedExpense(${f.id})" class="btn-small btn-ghost" style="padding: 6px 12px; font-size: 12px;">Modifica</button>
                <button onclick="deleteFixedExpense(${f.id})" class="btn-small btn-danger" style="padding: 6px 12px; font-size: 12px;">√ó</button>
            </div>
        </div>
    `).join('');
}

// FINE NUOVE FUNZIONI

function updateHeader() {
    document.getElementById('displayNome').textContent = data.user.name;
    document.getElementById('displayData').textContent = new Date().toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
    const settingsNome = document.getElementById('settingsNome');
    const settingsData = document.getElementById('settingsData');
    if(settingsNome) settingsNome.textContent = data.user.name;
    if(settingsData) settingsData.textContent = new Date(data.user.created).toLocaleDateString('it-IT');
}

function updateBudget() {
    const fixedTotal = data.fixed.reduce((a, f) => a + f.amount, 0);
    const expensesTotal = data.expenses.reduce((a, e) => a + e.amount, 0);
    const available = data.income - fixedTotal - expensesTotal;
    
    const displayLibero = document.getElementById('displayLibero');
    const displayEntrate = document.getElementById('displayEntrate');
    const displaySpese = document.getElementById('displaySpese');
    
    if(displayLibero) {
        displayLibero.textContent = '‚Ç¨' + available.toFixed(0);
        displayLibero.style.color = available < 0 ? '#ff3b30' : '#34c759';
    }
    if(displayEntrate) displayEntrate.textContent = '‚Ç¨' + data.income.toFixed(0);
    if(displaySpese) displaySpese.textContent = '‚Ç¨' + (fixedTotal + expensesTotal).toFixed(0);
}

function addSpesa() {
    const nameInput = document.getElementById('inputSpesaNome');
    const priceInput = document.getElementById('inputSpesaPrezzo');
    const typeInput = document.getElementById('inputSpesaTipo');
    const dateInput = document.getElementById('inputSpesaData');
    
    const name = nameInput.value.trim();
    const amount = parseFloat(priceInput.value);
    const type = typeInput.value;
    const date = dateInput.value || new Date().toISOString().split('T')[0];
    
    if(!name || !amount) return;
    
    data.expenses.push({ id: Date.now(), name, amount, type, date, isSaving: false });
    nameInput.value = '';
    priceInput.value = '';
    
    saveData();
    updateBudget();
    updateExpenses();
    updateCharts();
}

function updateExpenses() {
    const list = document.getElementById('listaSpese');
    if(!list) return;
    
    let filtered = data.expenses;
    if(currentFilter !== 'all') {
        filtered = data.expenses.filter(e => e.date.startsWith(currentFilter));
    }
    
    filtered = filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
    
    list.innerHTML = filtered.map(e => `
        <div class="list-item">
            <div>
                <div style="font-size: 15px; font-weight: 500;">${e.isSaving ? 'üí∞ ' : ''}${e.name}</div>
                <div style="font-size: 13px; color: #8e8e93;">${e.type} ‚Ä¢ ${new Date(e.date).toLocaleDateString('it-IT')}</div>
            </div>
            <div style="font-size: 15px; font-weight: 600; color: ${e.isSaving ? '#34c759' : '#000'};">‚Ç¨${e.amount}</div>
        </div>
    `).join('');
}

function clearFilter() {
    currentFilter = 'all';
    updateExpenses();
}

function createGoal() {
    const nameInput = document.getElementById('inputGoalNome');
    const targetInput = document.getElementById('inputGoalTarget');
    
    const name = nameInput.value.trim();
    const target = parseFloat(targetInput.value);
    
    if(!name || !target) return;
    
    data.goals.push({ id: Date.now(), name, target, saved: 0 });
    nameInput.value = '';
    targetInput.value = '';
    
    saveData();
    updateGoals();
}

function addToGoal(goalId, amount) {
    const goal = data.goals.find(g => g.id === goalId);
    if(!goal) return;
    
    const available = calculateAvailable();
    if(amount > available) {
        alert(`Budget insufficiente. Disponibile: ‚Ç¨${available.toFixed(2)}`);
        return;
    }
    
    const canAdd = Math.min(amount, goal.target - goal.saved);
    if(canAdd <= 0) return;
    
    data.expenses.push({
        id: Date.now(),
        name: `Risparmio: ${goal.name}`,
        amount: canAdd,
        type: 'Risparmio',
        date: new Date().toISOString().split('T')[0],
        isSaving: true,
        goalId: goal.id
    });
    
    goal.saved += canAdd;
    saveData();
    updateGoals();
    updateBudget();
    updateExpenses();
    updateCharts();
}

function addCustomToGoal(goalId) {
    const input = document.getElementById('goalInput_' + goalId);
    const amount = parseFloat(input.value);
    if(!amount || amount <= 0) return alert('Inserisci un importo valido');
    addToGoal(goalId, amount);
    input.value = '';
}

function deleteGoal(goalId) {
    if(!confirm('Eliminare questo obiettivo?')) return;
    data.expenses = data.expenses.filter(e => e.goalId !== goalId);
    data.goals = data.goals.filter(g => g.id !== goalId);
    saveData();
    updateGoals();
    updateBudget();
    updateExpenses();
    updateCharts();
}

function updateGoals() {
    const container = document.getElementById('listaGoals');
    if(!container) return;
    
    const available = calculateAvailable();
    
    if(data.goals.length === 0) {
        container.innerHTML = '<div class="card" style="text-align: center; padding: 40px; color: #8e8e93;">Nessun obiettivo</div>';
        return;
    }
    
    container.innerHTML = data.goals.map(g => {
        const percent = Math.min(100, (g.saved / g.target) * 100);
        const remaining = g.target - g.saved;
        const isComplete = g.saved >= g.target;
        
        return `
        <div class="card" style="${isComplete ? 'background: #34c759; color: #fff;' : ''}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="${isComplete ? 'color: rgba(255,255,255,0.8);' : ''}">Obiettivo</h3>
                    <h2 style="margin-top: 4px; font-size: 20px;">${g.name}</h2>
                </div>
                ${isComplete ? '<span style="font-size: 24px;">‚úì</span>' : `<button class="btn-small btn-ghost" onclick="deleteGoal(${g.id})" style="background: rgba(0,0,0,0.05);">√ó</button>`}
            </div>
            
            <div class="amount-small" style="margin-bottom: 8px;">
                ‚Ç¨${g.saved.toFixed(0)} <span style="opacity: 0.6; font-size: 18px;">/ ‚Ç¨${g.target}</span>
            </div>
            
            <div class="progress-bar" style="background: ${isComplete ? 'rgba(255,255,255,0.3)' : '#e5e5ea'};">
                <div class="progress-fill" style="width: ${percent}%; background: ${isComplete ? '#fff' : '#34c759'};"></div>
            </div>
            <p style="font-size: 13px; margin-top: 8px; opacity: 0.8;">
                ${percent.toFixed(0)}% ${isComplete ? '- Completato!' : `(mancano ‚Ç¨${remaining.toFixed(0)})`}
            </p>
            
            ${!isComplete ? `
            <div style="background: rgba(0,0,0,0.03); padding: 12px; border-radius: 12px; margin-top: 12px;">
                <p style="font-size: 12px; color: #8e8e93; margin-bottom: 8px;">Disponibile: ‚Ç¨${available.toFixed(2)}</p>
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="goalInput_${g.id}" placeholder="‚Ç¨" style="flex: 1; margin-bottom: 0; background: #fff; border-radius: 8px; padding: 10px; border: none;">
                    <button onclick="addCustomToGoal(${g.id})" class="btn-small" style="background: #007aff;">Aggiungi</button>
                </div>
                ${available > 0 ? `
                <button onclick="addToGoal(${g.id}, ${Math.min(available, remaining)})" style="margin-top: 8px; background: rgba(0,0,0,0.05); color: #000; font-size: 13px;">
                    Max: ‚Ç¨${Math.min(available, remaining).toFixed(0)}
                </button>
                ` : ''}
            </div>
            ` : ''}
        </div>
        `;
    }).join('');
}

function calculateAvailable() {
    const fixed = data.fixed.reduce((a, f) => a + f.amount, 0);
    const expenses = data.expenses.reduce((a, e) => a + e.amount, 0);
    return data.income - fixed - expenses;
}

function updateCharts() {
    updateTrendChart();
    updatePieChart();
}

function updateTrendChart() {
    const canvas = document.getElementById('chartTrend');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    canvas.width = rect.width * dpr;
    canvas.height = 180 * dpr;
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, rect.width, 180);
    
    const byMonth = {};
    data.expenses.filter(e => !e.isSaving).forEach(e => {
        const m = e.date.slice(0, 7);
        byMonth[m] = (byMonth[m] || 0) + e.amount;
    });
    
    const months = Object.keys(byMonth).sort().slice(-6);
    
    if(months.length === 0) {
        ctx.fillStyle = '#8e8e93';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato', rect.width / 2, 90);
        return;
    }
    
    const values = months.map(m => byMonth[m]);
    const max = Math.max(...values, 1);
    
    const padding = 20;
    const chartW = rect.width - padding * 2;
    const chartH = 120;
    const barW = chartW / months.length * 0.6;
    const gap = chartW / months.length * 0.4;
    
    months.forEach((m, i) => {
        const x = padding + i * (barW + gap) + gap / 2;
        const h = (values[i] / max) * chartH;
        const y = 20 + chartH - h;
        
        ctx.fillStyle = '#007aff';
        ctx.beginPath();
        ctx.roundRect(x, y, barW, h, 4);
        ctx.fill();
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('‚Ç¨' + Math.round(values[i]), x + barW / 2, y - 6);
        
        ctx.fillStyle = '#8e8e93';
        ctx.font = '10px sans-serif';
        const monthName = new Date(m + '-01').toLocaleString('it', { month: 'short' });
        ctx.fillText(monthName, x + barW / 2, 20 + chartH + 16);
    });
}

function updatePieChart() {
    const canvas = document.getElementById('chartPie');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    canvas.width = rect.width * dpr;
    canvas.height = 180 * dpr;
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, rect.width, 180);
    
    const byType = {};
    data.expenses.filter(e => !e.isSaving).forEach(e => {
        byType[e.type] = (byType[e.type] || 0) + e.amount;
    });
    
    const types = Object.keys(byType);
    const total = Object.values(byType).reduce((a, b) => a + b, 0);
    
    if(total === 0) {
        ctx.fillStyle = '#8e8e93';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Nessuna spesa', rect.width / 2, 90);
        return;
    }
    
    const cx = rect.width / 2;
    const cy = 80;
    const r = 50;
    
    let angle = -Math.PI / 2;
    const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5856d6'];
    
    types.forEach((t, i) => {
        const amt = byType[t];
        const a = (amt / total) * Math.PI * 2;
        
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, angle, angle + a);
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        
        const la = angle + a / 2;
        const lx = cx + Math.cos(la) * (r + 25);
        const ly = cy + Math.sin(la) * (r + 25);
        
        ctx.fillStyle = '#000';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(t, lx, ly - 4);
        ctx.fillStyle = '#8e8e93';
        ctx.fillText('‚Ç¨' + Math.round(amt), lx, ly + 10);
        
        angle += a;
    });
    
    ctx.beginPath();
    ctx.arc(cx, cy, r * 0.4, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    
    ctx.fillStyle = '#000';
    ctx.font = 'bold 13px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('‚Ç¨' + Math.round(total), cx, cy + 5);
}

function editName() {
    const newName = prompt('Nuovo nome:', data.user.name);
    if(newName) {
        data.user.name = newName;
        saveData();
        updateHeader();
    }
}

function copyBackup() {
    const code = btoa(JSON.stringify(data));
    navigator.clipboard.writeText(code).then(() => {
        const display = document.getElementById('backupDisplay');
        if(display) {
            display.textContent = code;
            display.style.display = 'block';
        }
        alert('Codice copiato negli appunti');
    });
}

function restoreBackup() {
    const code = document.getElementById('inputRestore').value.trim();
    if(!code) return;
    
    try {
        const restored = JSON.parse(atob(code));
        if(confirm(`Ripristinare backup di ${restored.user.name}?`)) {
            data = restored;
            if(!data.goals) data.goals = [];
            saveData();
            location.reload();
        }
    } catch(e) {
        alert('Codice non valido');
    }
}

function deleteAll() {
    if(confirm('Cancellare TUTTI i dati? Questa azione non pu√≤ essere annullata.')) {
        localStorage.removeItem('budgetData');
        location.reload();
    }
}

function switchTab(tab, element) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    const section = document.getElementById('section-' + tab);
    if(section) section.classList.add('active');
    if(element) element.classList.add('active');
    
    if(tab === 'stats') setTimeout(updateCharts, 100);
    if(tab === 'goals') updateGoals();
    if(tab === 'settings') updateFixedExpensesList(); // Aggiorna lista quando entri in settings
}

function saveData() {
    localStorage.setItem('budgetData', JSON.stringify(data));
}

function loadData() {
    const saved = localStorage.getItem('budgetData');
    if(saved) {
        try {
            data = JSON.parse(saved);
            if(!data.goals) data.goals = [];
            if(!data.fixed) data.fixed = [];
        } catch(e) {
            console.error('Errore caricamento dati');
        }
    }
}

// Esponi funzioni globali
window.selectAvatar = selectAvatar;
window.goSetup1 = goSetup1;
window.goSetup2 = goSetup2;
window.addFissaSetup = addFissaSetup;
window.finishSetup = finishSetup;
window.switchTab = switchTab;
window.addSpesa = addSpesa;
window.clearFilter = clearFilter;
window.createGoal = createGoal;
window.addToGoal = addToGoal;
window.addCustomToGoal = addCustomToGoal;
window.deleteGoal = deleteGoal;
window.editName = editName;
window.copyBackup = copyBackup;
window.restoreBackup = restoreBackup;
window.deleteAll = deleteAll;
window.toggleFixedForm = toggleFixedForm;
window.addFixedExpense = addFixedExpense;
window.editFixedExpense = editFixedExpense;
window.deleteFixedExpense = deleteFixedExpense;
</script>

</body>
</html>